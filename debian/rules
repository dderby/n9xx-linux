#!/usr/bin/make -f

CONFIG      = omap2plus_defconfig
CONFIG_PATH = arch/arm/configs
DTB         = omap3-n900.dtb
DEV         = n900
ARCH        = arm

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	BUILD_FLAGS += -j$(NUMJOBS)
endif

ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_TARGET_MULTIARCH))
	BUILD_FLAGS += CROSS_COMPILE=$(DEB_TARGET_MULTIARCH)-
endif

build-arch:
	ARCH=$(ARCH) scripts/kconfig/merge_config.sh $(CONFIG_PATH)/$(CONFIG) $(CONFIG_PATH)/common_fragments/* $(CONFIG_PATH)/$(DEV)_fragments/*
	$(MAKE) ARCH=$(ARCH) $(BUILD_FLAGS) zImage modules $(DTB)

binary-arch:
ifeq ($(DEB_BUILD_GNU_TYPE),$(DEB_TARGET_MULTIARCH))
	$(MAKE) ARCH=$(ARCH) DEV=$(DEV) DTB=$(DTB) $(BUILD_FLAGS) intdeb-pkg
else
	$(MAKE) ARCH=$(ARCH) $(BUILD_FLAGS) HOSTCC=$(DEB_TARGET_MULTIARCH)-gcc modules
	$(MAKE) ARCH=$(ARCH) DEV=$(DEV) DTB=$(DTB) $(BUILD_FLAGS) \
		HOSTCC=$(DEB_TARGET_MULTIARCH)-gcc intdeb-pkg
endif

clean:
	rm -rf debian/*tmp debian/files
	$(MAKE) mrproper

build:  build-arch
binary: binary-arch
